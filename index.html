<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        background: black;
        color: white;
        font-family: monospace;
        display: flex;
        font-size: 18px;
      }

      #wheel {
        width: 700px;
        height: 700px;
      }

      .rotating {
        transform: rotate(0deg);
      	animation: rotation 3s infinite linear;
      }

      .paused {
        -webkit-animation-play-state: paused;
        -moz-animation-play-state: paused;
        -o-animation-play-state: paused;
        animation-play-state: paused;
      }

      #wheel circle {
        fill: white;
      }

      #wheel .light {
        fill: url(#light);
        transition: opacity 0.05s;
      }

      #controls {
        padding: 1em;
      }

      #controls > div {
        padding: 10px;
      }

      label {
        width: 180px;
        display: inline-block;
        margin-right: 1em;
      }

      input {
        width: 300px;
      }

      @keyframes rotation {
      	from {
      		transform: rotate(0deg);
      	}

      	to {
      		transform: rotate(360deg);
      	}
      }
    </style>
    <script src="js/d3.v4.min.js"></script>
  </head>
  <body>
    <div>
      <svg id="wheel" class="rotating" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="light">
            <stop offset="40%" stop-color="rgba(255, 255, 0, 1)" />
            <stop offset="100%" stop-color="rgba(255, 255, 0, 0)" />
          </linearGradient>
        </defs>
      </svg>
    </div>
    <div id="controls">
      <div>
        <label for="range-wheel-rps">Wheel speed:</label>
        <input id="range-wheel-rps" type="range" min="-2" max="2" step="0.02" value="0.2">
      </div>
      <div>
        <label for="range-animation-rps">Animation speed:</label>
        <input id="range-animation-rps" type="range" min="-2" max="2" step="0.02" value="0.2">
      </div>
      <div>
        <label for="checkbox-lock-rps">Lock animation:</label>
        <input id="checkbox-lock-rps" checked type="checkbox">
      </div>
      <div>
        <label for="range-bpm">BPM:</label>
        <input id="range-bpm" type="range" min="20" max="180" step="1" value="60">
      </div>
      <div>
        <label for="select-pattern">Pattern:</label>
        <select id="select-pattern">
        </select>
      </div>
      <!-- <div>
        <label for="range-parameter">Parameter:</label>
        <input id="range-parameter" type="range" min="0" max="1" step="0.01" value="0.5">
      </div> -->
    </div>
    <script>
      var bpm = 60

      var width = 600
      var height = width

      var patterns = {
        'Single light': function (wheelAngle, ledAngle, beat, index) {
          var diff = Math.abs(wheelAngle - ledAngle)
          if (diff < 10) {
            return 1
          }
        },
        'Front': function (wheelAngle, ledAngle, beat, index) {
          var diff = Math.abs(ledAngle - 180)
          if (diff < 10) {
            return 1
          } else if (diff < 30) {
            return -(diff - 10) / 20 + 1
          }
        },
        alternating: function (wheelAngle, ledAngle, beat, index) {
          return (index + (beat % 2)) % 2
        },
        'Sine wave': function (wheelAngle, ledAngle, beat, index) {
          return (Math.sin(toRad((ledAngle - 45) * 2)) + 1) / 2
        },
        'Left/Right': function (wheelAngle, ledAngle, beat, index) {
          return (beat % 2) ? ledAngle <= 180 : ledAngle > 180
        }
      }

      var wheel = document.getElementById('wheel')

      var beat = 0
      var bpm = 0
      var animationRps = 0
      var wheelRps = 0

      var wheelAngle = 0
      var animationAngle = 0

      var lastBeatTimestamp = 0
      var lastAnimationAngleTimestamp = 0

      var lockRps = false
      var ledCount = 20

      var selectedPattern = Object.keys(patterns)[0]

      d3.select(wheel)
        .attr('viewBox', [0, 0, width, height].join(' '))

      d3.select('#select-pattern').selectAll('option')
        .data(Object.keys(patterns))
        .enter()
        .append('option')
        .attr('selected', function (d) {
          return selectedPattern === d ? 'selected' : null
        })
        .attr('value', function (d) {
          return d
        })
        .text(function (d) {
          return d
        })


      function toDeg (rad) {
        return rad * (180 / Math.PI)
      }

      function toRad (deg) {
        return deg / (180 / Math.PI)
      }

      function createLED (index) {
        var midX = width / 2
        var midY = height / 2

        var angle = 360 / (ledCount / index) + 90

        var g = d3.select(wheel).append('g')
          .attr('id', 'led-' + index)
          .attr('transform', 'rotate(' + [angle, midX, midY].join(' ') + ')')
          .attr('x', midX)
          .attr('y', midY)

        g.append('polygon')
          .attr('class', 'light')
          .attr('points', [
            [midX * 1.5, midY],
            [midX * 1.9, midY - 40],
            [midX * 1.9, midY + 40]
          ].map(function(coordinate) {
            return coordinate.join(',')
          }).join(' '))

        g.append('circle')
          .attr('class', 'led')
          .attr('cx', midX * 1.5 )
          .attr('cy', midY)
          .attr('r', 4)
      }

      function setLight (wheelAngle, ledAngle, beat, index) {
        var id = '#led-' + index

        var value = patterns[selectedPattern](wheelAngle, ledAngle, beat, index)

        if (!value) {
          value = 0
        } else if (value === true) {
          value = 1
        }

        d3.select(id + ' .light')
          .style('opacity', value)
      }

      for (var index = 0; index < ledCount; index++) {
        createLED(index)
      }

      function getWheelAngle () {
        var style = window.getComputedStyle(wheel)
        var transform = style.getPropertyValue('transform')

        var values = transform.split('(')[1];
        values = values.split(')')[0];
        values = values.split(',');

        var a = values[0]
        var b = values[1]

        var angle = Math.round(toDeg(Math.atan2(b, a))) + 180
        return angle
      }

      function animate () {
        var timestamp = Date.now()
        var beatDurationMs = 60 * 1000 / bpm
        if (timestamp - lastBeatTimestamp >= beatDurationMs) {
          beat += 1
          lastBeatTimestamp = timestamp
        }

        wheelAngle = getWheelAngle()

        var animationMsPerDegree = 1000 / (animationRps * 360)
        animationAngle = (animationAngle + (timestamp - lastAnimationAngleTimestamp) * (1 / animationMsPerDegree)) % 360
        lastAnimationAngleTimestamp = timestamp

        for (var index = 0; index < ledCount; index++) {
          var ledAngle = wheelAngle + (360 / ledCount) * index
          if (!lockRps) {
             ledAngle += animationAngle
          }
          ledAngle = ledAngle % 360
          setLight(wheelAngle, ledAngle, beat, index)
        }

        window.requestAnimationFrame(animate)
      }

      window.requestAnimationFrame(animate)

      function updateWheelRps () {
        wheelRps = parseFloat(wheelRpsSlider.value)
        var direction = wheelRps > 0 ? 'normal' : 'reverse'
        var duration = Math.abs(1 / wheelRps) + 's'

        if (wheelRps === 0) {
          wheel.classList.add('paused')
        } else {
          wheel.classList.remove('paused')
        }

        wheel.style.animationDuration = duration
        wheel.style.animationDirection = direction
      }

      function updateAnimationRps () {
        animationRps = parseFloat(animationRpsSlider.value)
      }

      function updateBpm () {
        bpm = bpmSlider.value
      }

      function updateLockRps () {
        lockRps = lockRpsCheckbox.checked
      }

      var wheelRpsSlider = document.getElementById('range-wheel-rps')
      wheelRpsSlider.addEventListener('input', updateWheelRps)

      var animationRpsSlider = document.getElementById('range-animation-rps')
      animationRpsSlider.addEventListener('input', updateAnimationRps)

      var bpmSlider = document.getElementById('range-bpm')
      bpmSlider.addEventListener('input', updateBpm)

      var lockRpsCheckbox = document.getElementById('checkbox-lock-rps')
      lockRpsCheckbox.addEventListener('input', updateLockRps)

      var selectPattern = document.getElementById('select-pattern')
      selectPattern.addEventListener('input', function () {
        selectedPattern = selectPattern.value
      })

      updateWheelRps()
      updateAnimationRps()
      updateBpm()
      updateLockRps()

    </script>
  </body>
</html>
